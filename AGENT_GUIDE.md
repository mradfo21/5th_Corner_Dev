# SOMEWHERE STORYGEN - AGENT GUIDE
## An AI-Driven First-Person Survival Game in Discord

---

## üéÆ WHAT IS THIS?

A Discord bot that runs a **first-person survival horror game** where:
- Every scene is **generated in real-time by AI** (Gemini)
- Choices affect the narrative and world state
- Images are **photorealistic, first-person perspective** (like bodycam footage)
- Death is permanent (but you can restart)
- The world evolves based on player actions
- Inactivity leads to brutal timeout penalties

**Core Loop:** See image ‚Üí Read dispatch ‚Üí Choose action ‚Üí Consequence ‚Üí New image ‚Üí Repeat

---

## üèóÔ∏è ARCHITECTURE OVERVIEW

### File Structure

```
bot.py                          # Discord bot, UI, buttons, game loop orchestration
engine.py                       # Core game engine, turn processing, state management
choices.py                      # LLM-based choice generation
gemini_image_utils.py           # Image generation (text-to-image, img2img)
evolve_prompt_file.py           # World state evolution logic
prompts/simulation_prompts.json # ALL LLM prompts and instructions (CRITICAL FILE)
config.json                     # Gemini API keys, model configs
world_state.json                # Runtime: Current game state (location, health, etc.)
history.json                    # Runtime: Full narrative history
images/                         # Runtime: Generated images (high-res + thumbnails)
tapes/                          # Runtime: Death replay GIFs
```

### Tech Stack

- **Discord.py** - Bot framework, UI (buttons, embeds)
- **Google Gemini API** - Text generation (Flash 2.0) + Image generation (Imagen 3)
- **Pillow (PIL)** - Image processing, GIF creation
- **asyncio** - Async task management (timers, auto-play)
- **Python 3.11+** - Core language

---

## üß† KEY SYSTEMS EXPLAINED

### 1. **IMAGE GENERATION PIPELINE** (`gemini_image_utils.py`)

**Two modes:**
- **Text-to-Image (T2I):** First image of the game (intro shot)
- **Image-to-Image (Img2Img):** All subsequent turns (continuity with previous scene)

**Critical Mechanics:**
- **HD Mode Toggle:** User can switch between Gemini Pro (slow, high-quality) and Flash (fast, lower-quality)
- **Reference Images:** 
  - **1 reference image** ‚Üí More dramatic change (for action choices like "climb," "run," "attack")
  - **2 reference images** ‚Üí More continuity (for stationary choices like "wait," "examine," "speak")
- **Prompt Sanitization:** Violent/graphic terms are replaced with clinical equivalents to bypass Gemini safety filters
  - Example: "blood splatter" ‚Üí "tissue damage," "severed limb" ‚Üí "traumatic amputation"
- **Anti-Border Instructions:** Aggressively injected to prevent photo frames/borders in images
- **Anti-Person Instructions:** Prevents rendering the player character (first-person POV only)

**Key Functions:**
- `generate_with_gemini()` - T2I for intro
- `generate_gemini_img2img()` - Img2Img for all turns
- `_sanitize_for_safety()` - Replaces violent terms for safety filter bypass

### 2. **NARRATIVE ENGINE** (`engine.py`)

**Turn Processing Flow:**
```
1. Player picks choice
2. Calculate consequence (LLM analyzes risk ‚Üí outcome)
3. Update world state (environment evolves)
4. Generate new dispatch (narrative text)
5. Generate new image (Img2Img with reference images)
6. Generate 4 new choices (based on current image + dispatch ONLY)
7. Display to player
```

**World State Management:**
- **`world_state.json`** stores: location, health, inventory, environment conditions, NPC states
- **World Evolution LLM** updates state each turn based on player action + time passage
- **CRITICAL CONSTRAINT:** Evolution must stay grounded (no hallucinating corn fields in deserts!)

**Key Functions:**
- `game_turn()` - Main turn processing
- `evolve_world_state()` - Updates world state (in `evolve_prompt_file.py`)
- `_generate_combined_dispatches()` - Generates narrative text
- `_gen_image()` - Orchestrates image generation with dynamic reference count

### 3. **CHOICE GENERATION** (`choices.py`)

**How Choices Work:**
- Generated by LLM using **ONLY** the current image + current dispatch
- **NO world state context** (prevents stale/desync'd choices)
- Vision analysis of image to ground choices in visible threats/opportunities
- 4 choices per turn: varied, exciting, never generic

**Choice Types Encouraged:**
- **BOLD** - High-risk, high-reward
- **CLEVER** - Creative problem-solving
- **WEIRD** - Unexpected, experimental
- **INVESTIGATIVE** - Information gathering

**Anti-Patterns to Avoid:**
- Generic choices ("Look around," "Move forward")
- Choices that don't match visible scene
- Repetitive options

**Key Function:**
- `generate_player_choices_for_turn()` - Generates 4 choices with vision grounding

### 4. **CONSEQUENCE SYSTEM** (Prompt: `action_consequence_instructions`)

**Philosophy: FAIR BUT TENSE**

**For Regular Choices:**
- Normal movement is **SAFE** (no random injuries)
- Cautious choices are **REWARDED**
- Risky choices have **REAL CONSEQUENCES**
- Only clearly fatal actions cause death

**For Negative Consequences:**
- Can be **DEADLY AND GRUESOME**
- World turns against you
- Vivid, visceral outcomes

**For Timeout Penalties (Hesitation):**
- **EXTREMELY BRUTAL**
- Radically escalates danger
- Often deadly (but not always instant death)
- Consequence LLM decides final fate

**Death Determination:**
```json
{
  "player_alive": true/false,
  "consequence": "narrative text",
  "severity": "minor/moderate/severe/fatal"
}
```

### 5. **TIMEOUT PENALTY SYSTEM** (15-second countdown)

**Mechanics:**
- Each turn starts a 15-second countdown
- If no choice picked ‚Üí **Timeout Penalty** injected as player action
- Penalty prompt: "You hesitate too long. The world acts."
- Consequence LLM treats it as a **dangerous inaction event**
- Often results in severe harm or death

**Auto-Play Interaction:**
- When Auto-Play is ON ‚Üí Countdown is **DISABLED**
- Auto-Play picks choices on its own schedule (45 seconds default)
- No timeout penalties during auto-play

**Task Management:**
- Countdown and auto-play are separate `asyncio` tasks
- Tasks are cancelled on: game restart, manual choice, death
- **CRITICAL:** Must cancel tasks properly to avoid conflicts

### 6. **DEATH REPLAY SYSTEM** (VHS Tapes)

**How It Works:**
- Every high-res image is tracked in `_run_images` list
- On death or restart ‚Üí Creates GIF from all images
- GIF settings: 500ms per frame (2x speed), loop forever
- Saved to `tapes/tape_{timestamp}.gif`
- Posted to Discord with "üìº VHS TAPE" embed

**Use Cases:**
- Player dies ‚Üí Tape generated automatically
- Player presses Restart ‚Üí Tape generated before reset
- Allows overnight auto-play runs to be saved as movies

---

## üéØ PROMPT ENGINEERING PHILOSOPHY

**Everything is in `prompts/simulation_prompts.json`** - This is the **MOST IMPORTANT FILE**

### Key Principles:

1. **EXPLICIT > IMPLICIT**
   - LLMs ignore vague hints
   - Use CAPS for critical instructions
   - Repeat constraints in multiple ways

2. **NEGATIVE PROMPTS ARE ESSENTIAL**
   - Tell the LLM what NOT to do
   - For images: borders, people, limbs, objects
   - For text: hallucinations, stale data, generic choices

3. **GROUNDING IN CONTEXT**
   - Choices: Only use current image + dispatch
   - World evolution: Only modify current location, no teleportation
   - Consequences: Based on actual risk, not random

4. **MULTIMODAL IS POWERFUL**
   - Pass images to LLMs for better text generation
   - Vision analysis prevents "blind" choice generation
   - Img2Img creates visual continuity

5. **SAFETY FILTER WORKAROUNDS**
   - Gemini blocks violent content
   - Solution: Sanitize prompts with clinical terms
   - Apply to image generation, not text generation (text is fine)

### Critical Prompts to Understand:

- **`image_negative_prompt`** - What NOT to put in images
- **`action_consequence_instructions`** - How to determine outcomes
- **`timeout_penalty_instructions`** - How to handle hesitation
- **`player_choice_generation_instructions`** - How to create exciting choices
- **`world_evolution_instructions`** - How to evolve environment without hallucinating

---

## üêõ COMMON ISSUES & SOLUTIONS

### Issue: "Photo borders keep appearing"
**Solution:** 
- Add more anti-border terms to `image_negative_prompt`
- Inject explicit "NO BORDERS" instructions in image generation calls
- Check if it's intentional (binoculars, scope, etc.)

### Issue: "Choices don't match the scene"
**Solution:**
- Ensure choices are generated from current image + dispatch ONLY
- Don't pass world_state to choice generation
- Use vision analysis to ground choices

### Issue: "Player keeps getting injured by normal movement"
**Solution:**
- Strengthen "Normal movement is SAFE" instruction in consequence prompt
- Only apply harsh consequences to risky/reckless choices

### Issue: "World evolution hallucinates new locations"
**Solution:**
- Add stronger constraints: "STAY IN CURRENT LOCATION"
- "NEVER invent new biomes"
- "ONLY modify existing environment"

### Issue: "Gemini blocks image generation (violence)"
**Solution:**
- Expand `_sanitize_for_safety()` in `gemini_image_utils.py`
- Replace graphic terms with clinical equivalents
- Test with specific blocked terms

### Issue: "Not enough visual progression between scenes"
**Solution:**
- Use 1 reference image for action choices (more dramatic change)
- Add "SHOW THE NEXT MOMENT, NOT THE SAME MOMENT" to img2img prompt
- Reduce img2img continuity strength

### Issue: "Auto-play causes timeout penalties"
**Solution:**
- Disable countdown when auto-play is enabled
- Cancel countdown task when auto-play picks a choice
- Check `start_countdown_timer()` and `auto_advance_turn()` logic

### Issue: "Old tasks still running after restart"
**Solution:**
- Cancel `auto_advance_task` and `countdown_task` in all restart flows
- Check: `_do_reset_static()`, `RestartButton.callback()`, death sequences

---

## üöÄ DEPLOYMENT NOTES

### Environment Variables Needed:
```
DISCORD_TOKEN=your_discord_bot_token
GEMINI_API_KEY=your_gemini_api_key
```

### Discord Bot Permissions:
- Send Messages
- Embed Links
- Attach Files
- Read Message History
- Use Slash Commands (optional)

### Runtime Folders (Auto-Created):
- `images/` - Generated scene images
- `tapes/` - Death replay GIFs
- `logs/` - Error and evolution logs

### API Rate Limits:
- **Gemini Flash:** ~60 requests/minute (fast, suitable for auto-play)
- **Gemini Pro:** ~10 requests/minute (slow, high-quality)
- If rate limited, bot will retry with exponential backoff

### Performance:
- Flash mode: ~10-15 seconds per turn
- Pro mode: ~30-60 seconds per turn
- Auto-play default: 45 seconds between choices

---

## üîß MODIFYING THE GAME

### Want to change difficulty?
‚Üí Edit `action_consequence_instructions` in `simulation_prompts.json`

### Want different image styles?
‚Üí Edit `gemini_text_to_image_instructions` and `image_negative_prompt`

### Want different choice types?
‚Üí Edit `player_choice_generation_instructions`

### Want faster/slower auto-play?
‚Üí Change `AUTO_PLAY_DELAY` in `bot.py` (default: 45 seconds)

### Want different timeout penalty severity?
‚Üí Edit `timeout_penalty_instructions`

### Want to adjust visual continuity?
‚Üí Modify reference image count logic in `engine.py` `_gen_image()`

---

## üí° DESIGN INSIGHTS

### Why img2img instead of pure T2I?
- Visual continuity between scenes (doesn't look like random images)
- Maintains art style, lighting, and environmental consistency
- Grounds image generation in previous context

### Why separate consequence LLM call?
- Allows fair evaluation of risk before outcome
- Prevents narrative LLM from inventing consequences
- Enables structured death determination (`player_alive` flag)

### Why only use current image + dispatch for choices?
- Prevents stale/desync'd choices from world state
- Ensures choices match what player can actually see
- Reduces hallucinations

### Why sanitize violence for images but not text?
- Gemini image generation is more sensitive than text generation
- Text can describe violence narratively without triggering blocks
- Images require clinical terminology to bypass safety filters

### Why 15-second countdown?
- Creates tension and urgency
- Punishes overthinking/hesitation (thematically appropriate)
- Encourages instinctive decision-making

### Why death replay GIFs?
- Provides closure (you can see how you died)
- Creates shareable "highlight reel" of run
- Allows overnight auto-play runs to be preserved

---

## üé® FUTURE ENHANCEMENT IDEAS

- **Sound effects** (gunshots, footsteps, ambient audio)
- **Multiplayer** (multiple players in same world)
- **Persistent world** (deaths don't reset environment)
- **Character customization** (choose role, skills)
- **Inventory system** (pickup/use items)
- **NPC dialogue trees** (branching conversations)
- **Save/load system** (bookmark good runs)
- **Leaderboard** (longest survival time)

---

## üìù FINAL NOTES FOR NEXT AGENT

### This codebase is PROMPT-DRIVEN
- 80% of behavior is controlled by prompts in `simulation_prompts.json`
- When things break, check prompts first, code second
- LLMs are unpredictable - test changes thoroughly

### The User's Vision
- **Fair but tense** survival experience
- **Visually stunning** photorealistic imagery
- **Emergent storytelling** from AI decisions
- **Punishing but not unfair** difficulty
- **First-person immersion** (bodycam aesthetic)

### What Works Well
- Consequence system balances fairness and lethality
- Image generation creates compelling visuals
- Choice variety keeps gameplay interesting
- Death replays provide satisfying closure
- HD toggle lets users balance speed vs quality

### Known Quirks
- Gemini safety filters are sensitive (hence sanitization)
- Img2img continuity can make scenes too static (hence dynamic reference count)
- World evolution can hallucinate (hence strong constraints)
- Async task management is tricky (hence explicit cancellation everywhere)

### If User Wants Changes
- **Listen carefully** to what feels "unfun" or "unfair"
- **Test changes** by actually playing the game
- **Iterate on prompts** rather than rewriting code
- **Preserve the core loop** (image ‚Üí dispatch ‚Üí choices ‚Üí consequence)

---

**Good luck, next agent! This is a unique and ambitious project. Approach it with curiosity and playfulness. The user has great instincts for game feel - trust their feedback.**

üéÆüìºüî•

