# üìú History Inspection Feature - Complete Documentation

## Overview

The **History Inspection Feature** provides deep debugging and monitoring capabilities for game sessions through the admin dashboard. It allows you to inspect every detail of gameplay including AI prompts, responses, images generated, and raw JSON data.

---

## üéØ Use Cases

### 1. **Live Debugging**
- Something weird happened in the game? Inspect the exact prompts and AI responses.
- Check if the AI is following your instructions correctly.
- Verify image generation prompts match the narrative.

### 2. **Quality Assurance**
- Review gameplay flow and narrative quality.
- Ensure choices are contextually appropriate.
- Verify location and time tracking.

### 3. **Prompt Engineering**
- See exactly what prompts are being sent to AI models.
- Identify patterns in successful vs. problematic generations.
- Refine prompts based on actual usage data.

### 4. **Session Analysis**
- Understand player journey through a session.
- Identify where players get stuck or confused.
- Review pacing and tension escalation.

---

## üîß Technical Implementation

### API Endpoint

**`GET /api/sessions/{session_id}/history`**

**Query Parameters:**
- `limit` (optional): Maximum number of entries to return (default: all)
- `offset` (optional): Skip N entries from the start (for pagination)

**Response:**
```json
{
  "success": true,
  "message": "History retrieved (3/3 entries)",
  "data": {
    "session_id": "default",
    "total_entries": 3,
    "returned_entries": 3,
    "offset": 0,
    "history": [
      {
        "turn_count": 1,
        "choice": "Player action text",
        "dispatch": "AI narrative response",
        "vision_dispatch": "Image description",
        "consequence_img_prompt": "Image generation prompt",
        "consequence_img_url": "images/file.png",
        "choices": ["Choice 1", "Choice 2", "Choice 3"],
        "location": "Current location",
        "time_of_day": "Current time",
        "timestamp": "2025-12-20T20:30:00Z",
        "narrative_prompt": "Prompt sent to narrative AI",
        "choices_prompt": "Prompt sent to choices AI"
      }
    ]
  }
}
```

---

## üé® Dashboard UI

### Accessing History

1. Open the admin dashboard: `http://localhost:5001/admin_dashboard.html`
2. Click on any session card to view details
3. Scroll down to the **"üìú Full History & Prompts"** section

### UI Features

#### **Collapsible Turn Entries**
- Each turn is displayed as a collapsible card
- Click the header to expand/collapse
- Shows turn number and player action in the header

#### **Expand/Collapse All**
- **Expand All** button: Opens all turn entries at once
- **Collapse All** button: Closes all turn entries
- Useful for quickly scanning or deep diving

#### **Per-Turn Information**

Each turn entry shows:

1. **Player Action** - What the player chose to do
2. **Narrative (AI Response)** - The story text generated by AI
3. **Vision Description** - Description of what's shown in the image
4. **Image Generation Prompt** - Exact prompt sent to image AI
5. **Generated Image** - Link to view/download the image
6. **Choices Presented** - The 3 choices offered to the player
7. **Narrative Generation Prompt** - Full prompt sent to narrative AI
8. **Choices Generation Prompt** - Full prompt sent to choices AI
9. **Location** - Where the player is in the game world
10. **Time of Day** - Current time in the game
11. **Raw JSON** - Complete entry data with syntax highlighting

#### **Syntax Highlighting**

The Raw JSON view includes basic syntax highlighting:
- **Keys**: Red (`"choice": `)
- **Strings**: Cyan (`"Player action text"`)
- **Numbers**: Yellow (`123`)
- **Booleans**: Purple (`true`, `false`, `null`)

---

## üí° Usage Examples

### Example 1: Debugging Weird AI Response

**Problem:** The AI generated a nonsensical response.

**Solution:**
1. Open the dashboard
2. Navigate to the session
3. Expand the problematic turn
4. Check the **Narrative Generation Prompt**
5. Verify if:
   - Context was passed correctly
   - Player action was interpreted properly
   - Any prompt engineering issues exist

### Example 2: Image Not Matching Narrative

**Problem:** Generated image doesn't match the story.

**Solution:**
1. Find the turn in history
2. Compare:
   - **Narrative (AI Response)** - What the story says
   - **Vision Description** - What should be in the image
   - **Image Generation Prompt** - What was actually sent to the image AI
3. Identify disconnect and adjust prompt engineering

### Example 3: Reviewing Player Journey

**Scenario:** Want to understand a full play session.

**Solution:**
1. Click **Expand All** to see the entire journey
2. Scroll through turn-by-turn
3. Look for:
   - Narrative consistency
   - Choice quality
   - Pacing issues
   - Location/time tracking

---

## üîí Security Considerations

### Path Traversal Prevention

The image link generation in the history viewer uses the safe API endpoint:

```javascript
`${API_BASE}/sessions/${sessionId}/images/${imageName}`
```

This leverages the existing path traversal protection in `api.py` that validates filenames to prevent directory traversal attacks.

### Data Privacy

- History data is stored per-session, isolated from other sessions
- No sensitive user data is logged in history
- All data is stored locally, not sent to external services

---

## üìä Data Structure

### History Entry Fields

| Field | Type | Description |
|-------|------|-------------|
| `turn_count` | int | Turn number |
| `choice` / `action` | string | Player's chosen action |
| `dispatch` | string | Narrative response from AI |
| `vision_dispatch` | string | Description of image content |
| `consequence_img_prompt` | string | Prompt for image generation |
| `consequence_img_url` | string | Path to generated image |
| `choices` | array | List of choices presented |
| `location` | string | Game location |
| `time_of_day` | string | Game time |
| `timestamp` | string | ISO 8601 timestamp |
| `narrative_prompt` | string | Full narrative AI prompt |
| `choices_prompt` | string | Full choices AI prompt |

---

## üß™ Testing

### Test History Creation

Use `create_test_history.py` to generate sample data:

```powershell
python create_test_history.py
```

This creates 3 test turns with realistic analog horror content.

### API Testing

Use `test_history_api.py` to verify the endpoint:

```powershell
python test_history_api.py
```

Tests:
- ‚úÖ Basic history retrieval
- ‚úÖ Pagination (limit parameter)
- ‚úÖ Non-existent session handling

---

## üé® Styling

### Colors & Theme

The history viewer uses the dashboard's VHS horror aesthetic:

- **Background**: Dark blue/purple gradient
- **Cards**: Glassmorphic with blur effect
- **Accent**: Cyan (`#4ecdc4`)
- **Danger**: Red (`#ff6b6b`)
- **Text**: Light gray (`#e0e0e0`)

### Responsive Design

- Modal expands to 900px wide (from 600px)
- Scrollable content with max-height: 85vh
- Mobile-friendly collapsible sections

---

## üöÄ Future Enhancements

### Potential Improvements

1. **Search & Filter**
   - Search by text content
   - Filter by turn number range
   - Filter by location or time of day

2. **Export Functionality**
   - Download full history as JSON
   - Export as formatted text/markdown
   - Generate gameplay report

3. **Timeline Visualization**
   - Visual timeline of gameplay
   - Location map showing player movement
   - Time progression graph

4. **AI Model Metrics**
   - Token usage per turn
   - Response times
   - Cost tracking

5. **Comparison View**
   - Compare prompts across turns
   - Highlight prompt evolution
   - Side-by-side turn comparison

---

## üìù Integration Points

### With Existing Systems

The history inspection feature integrates seamlessly with:

1. **Engine (`engine.py`)**
   - Uses `get_history(session_id)` to load data
   - No changes needed to existing history saving

2. **API (`api.py`)**
   - New `/sessions/{id}/history` endpoint
   - Reuses existing session validation
   - Compatible with asset serving endpoints

3. **Admin Dashboard (`admin_dashboard.html`)**
   - Integrated into session details modal
   - Shares styling with tape viewer
   - Uses same API base URL

---

## ‚úÖ Completion Checklist

- [x] API endpoint created and tested
- [x] Dashboard UI implemented with collapsible entries
- [x] Syntax highlighting for JSON
- [x] Expand/Collapse All functionality
- [x] Image link generation with proper URLs
- [x] All prompt types displayed (narrative, choices, image)
- [x] Location and time tracking shown
- [x] Raw JSON view for debugging
- [x] Test data creation script
- [x] API testing script
- [x] Documentation complete

---

## üéì Developer Notes

### Adding New Fields to History

If you add new fields to history entries in `engine.py`:

1. They will automatically appear in the API response
2. Update `buildHistoryEntryDetails()` in `admin_dashboard.html` to display them nicely
3. Add them to the "Data Structure" section of this document

### Performance Considerations

- History files are JSON, loaded entirely into memory
- For very long play sessions (100+ turns), consider pagination
- The `limit` query parameter is available but not exposed in UI yet

### Browser Compatibility

Tested and working on:
- Chrome/Edge (Chromium)
- Firefox
- Safari (should work, not extensively tested)

---

## üìû Support

If you encounter issues with the history inspection feature:

1. Check browser console for JavaScript errors
2. Verify API server is running (`python test_bot_health.py`)
3. Test the endpoint directly: `curl http://localhost:5001/api/sessions/default/history`
4. Check that session has history data

---

## üéâ Summary

The History Inspection Feature provides **comprehensive debugging and monitoring** capabilities essential for:

- **Live troubleshooting** when something goes wrong
- **Quality assurance** for narrative and image generation
- **Prompt engineering** to improve AI outputs
- **Session analysis** to understand player experience

It's designed to be **fast, intuitive, and powerful** - giving you complete visibility into every aspect of gameplay.

**Access it now:** Open the admin dashboard, click any session, and explore! üöÄ

