<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analog Horror StoryGen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=Share+Tech+Mono&display=swap');
    body {
      background: #181818;
      color: #e0e0e0;
      font-family: 'Share Tech Mono', 'IBM Plex Mono', 'Consolas', monospace;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    .letterbox {
      position: fixed;
      left: 0; right: 0;
      height: 7vw;
      background: #000;
      z-index: 100;
      pointer-events: none;
      transition: opacity 0.7s;
    }
    .letterbox.top { top: 0; }
    .letterbox.bottom { bottom: 0; }
    .grain {
      pointer-events: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      z-index: 99;
      opacity: 0.13;
      background: url('https://www.transparenttextures.com/patterns/noise.png');
      mix-blend-mode: screen;
      animation: grainmove 2.5s infinite linear alternate;
    }
    @keyframes grainmove {
      0% { background-position: 0 0; }
      100% { background-position: 100px 60px; }
    }
    .scanlines {
      pointer-events: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      z-index: 98;
      background: repeating-linear-gradient(
        to bottom, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 2px, transparent 4px
      );
      mix-blend-mode: overlay;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: #232323;
      border-radius: 8px;
      box-shadow: 0 2px 16px #000a;
      padding: 2rem 2.5rem 2.5rem 2.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 101;
    }
    h1 {
      font-size: 1.7em;
      letter-spacing: 2px;
      margin-bottom: 0.5em;
      color: #ff5555;
      text-shadow: 0 2px 8px #000a;
      font-family: 'Share Tech Mono', monospace;
    }
    .narrative, #consequence, #danger-indicator {
      opacity: 0;
      transition: opacity 0.7s cubic-bezier(0.4,0,0.2,1);
    }
    .narrative.visible, #consequence.visible, #danger-indicator.visible {
      opacity: 1;
    }
    .narrative {
      font-size: 1.13em;
      margin-bottom: 1.2em;
      background: #181818;
      border-radius: 6px;
      padding: 1em 1.2em;
      box-shadow: 0 1px 4px #0006;
      min-height: 60px;
      white-space: pre-line;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 0.5px;
    }
    .story-image {
      width: 100%;
      max-width: 420px;
      border-radius: 6px;
      margin-bottom: 1.2em;
      box-shadow: 0 2px 12px #000a;
      background: #111;
      object-fit: contain;
      opacity: 0;
      transition: opacity 0.7s cubic-bezier(0.4,0,0.2,1);
    }
    .story-image.visible {
      opacity: 1;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      width: 100%;
      margin-bottom: 1.5em;
      opacity: 0;
      transition: opacity 0.7s cubic-bezier(0.4,0,0.2,1);
    }
    .choices.visible {
      opacity: 1;
    }
    .choice-btn {
      background: #282828;
      color: #fff;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 0.7em 1.2em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border 0.15s, transform 0.18s cubic-bezier(0.4,0,0.2,1);
      text-align: left;
      font-family: 'Share Tech Mono', monospace;
      box-shadow: 0 1px 4px #0004;
      outline: none;
      position: relative;
      z-index: 1;
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      animation: btn-pop 0.5s cubic-bezier(0.4,0,0.2,1) forwards;
      animation-delay: var(--btn-delay, 0s);
    }
    @keyframes btn-pop {
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .choice-btn:focus {
      border: 2px solid #ff5555;
      background: #222;
    }
    .choice-btn:hover {
      background: #ff5555;
      color: #fff;
      border: 1px solid #ff8888;
      transform: scale(1.03);
      z-index: 2;
    }
    .reset-btn {
      background: #222;
      color: #ff8888;
      border: 1px solid #ff8888;
      border-radius: 5px;
      padding: 0.5em 1.2em;
      font-size: 0.95em;
      cursor: pointer;
      margin-top: 0.5em;
      transition: background 0.15s, color 0.15s;
      font-family: 'Share Tech Mono', monospace;
    }
    .reset-btn:hover {
      background: #ff8888;
      color: #222;
    }
    #danger-indicator {
      animation: danger-pulse 1.2s infinite alternate;
      box-shadow: 0 2px 8px #ff222240, 0 0 16px #ff222220;
      border-width: 2.5px;
    }
    @keyframes danger-pulse {
      0% { background: #fff0f0; color: #ff2222; }
      100% { background: #ff2222; color: #fff0f0; }
    }
    @media (max-width: 700px) {
      .container { max-width: 98vw; padding: 1em 0.5em; }
      .story-image { max-width: 98vw; }
      .letterbox { height: 10vw; }
    }
    .consequence-pulse {
      animation: pulse-fade 1.1s cubic-bezier(0.4,0,0.2,1);
    }
    @keyframes pulse-fade {
      0% { background: #fffbe6; color: #b85c00; border-color: #ffbb33; opacity: 0.2; }
      30% { background: #ffbb33; color: #222; border-color: #ffbb33; opacity: 1; }
      60% { background: #fffbe6; color: #b85c00; border-color: #ffbb33; opacity: 1; }
      100% { background: #fffbe6; color: #b85c00; border-color: #ffbb33; opacity: 1; }
    }
    .gameover-overlay {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.92);
      z-index: 9999;
      color: #fff;
      font-family: 'Share Tech Mono', monospace;
      font-size: 2.2em;
      text-align: center;
      padding-top: 18vh;
      letter-spacing: 2px;
      transition: opacity 0.7s;
    }
    .gameover-overlay.visible {
      display: block;
      opacity: 1;
    }
    .restart-btn {
      background: #222;
      color: #ff8888;
      border: 2px solid #ff8888;
      border-radius: 7px;
      padding: 0.7em 2em;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 2em;
      font-family: 'Share Tech Mono', monospace;
      transition: background 0.15s, color 0.15s;
    }
    .restart-btn:hover {
      background: #ff8888;
      color: #222;
    }
    .dice-suspense {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      z-index: 9998;
      color: #fff;
      font-family: 'Share Tech Mono', monospace;
      font-size: 2em;
      text-align: center;
      padding-top: 30vh;
      letter-spacing: 2px;
      background: rgba(0,0,0,0.7);
    }
    .dice-suspense.visible {
      display: block;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="letterbox top"></div>
  <div class="letterbox bottom"></div>
  <div class="grain"></div>
  <div class="scanlines"></div>
  <div class="gameover-overlay" id="gameover-overlay">
    <div>üíÄ GAME OVER<br><span style="font-size:0.7em;">Jason has died.</span><br>
      <button class="restart-btn" onclick="resetGame()">Restart</button>
    </div>
  </div>
  <div class="dice-suspense" id="dice-suspense">üé≤ Rolling the dice...</div>
  <div class="container" aria-label="Story container">
    <h1>Analog Horror StoryGen</h1>
    <div class="narrative" id="narrative" aria-live="polite">Loading...</div>
    <div id="consequence" style="display:none; font-weight:bold; color:#b85c00; background:#fffbe6; border:2px solid #ffbb33; border-radius:6px; margin-bottom:1em; font-size:1.1em; padding:0.7em 1em; box-shadow:0 2px 8px #ffbb3340; transition:background 0.3s, color 0.3s, border 0.3s, opacity 0.3s;"></div>
    <div id="danger-indicator" style="display:none; font-weight:bold; color:#ff2222; background:#fff0f0; border:2px solid #ff2222; border-radius:6px; margin-bottom:1em; font-size:1.1em; padding:0.7em 1em; box-shadow:0 2px 8px #ff222240; transition:background 0.3s, color 0.3s, border 0.3s, opacity 0.3s;"></div>
    <img class="story-image" id="story-image" src="" alt="" style="display:none;" aria-label="Story image" />
    <div class="choices" id="choices" role="group" aria-label="Choices"></div>
    <button class="reset-btn" onclick="resetGame()">Reset Simulation</button>
  </div>
  <script>
    // Cinematic staggered reveal
    function revealCinematic() {
      const narrative = document.getElementById('narrative');
      const consequence = document.getElementById('consequence');
      const danger = document.getElementById('danger-indicator');
      const choices = document.getElementById('choices');
      const img = document.getElementById('story-image');
      // Hide all first
      narrative.classList.remove('visible');
      consequence.classList.remove('visible');
      danger.classList.remove('visible');
      choices.classList.remove('visible');
      img.classList.remove('visible');
      // Staggered reveal
      setTimeout(() => { narrative.classList.add('visible'); }, 100);
      setTimeout(() => { consequence.classList.add('visible'); }, 700);
      setTimeout(() => { danger.classList.add('visible'); }, 1200);
      setTimeout(() => { img.classList.add('visible'); }, 1500);
      setTimeout(() => { choices.classList.add('visible'); }, 1800);
    }
    async function fetchState() {
      const res = await fetch('/api/state');
      const data = await res.json();
      document.getElementById('narrative').textContent = data.situation_report || '...';
      // Consequence feedback (hide if not present)
      const consequenceDiv = document.getElementById('consequence');
      if (data.consequences) {
        consequenceDiv.style.display = '';
        consequenceDiv.textContent = `‚ö†Ô∏è Consequence: ${data.consequences}`;
        consequenceDiv.classList.remove('consequence-pulse');
        void consequenceDiv.offsetWidth; // force reflow for animation
        consequenceDiv.classList.add('consequence-pulse');
      } else {
        consequenceDiv.style.display = 'none';
        consequenceDiv.textContent = '';
        consequenceDiv.classList.remove('consequence-pulse');
      }
      const img = document.getElementById('story-image');
      if (data.world_image) {
        img.src = data.world_image;
        img.style.display = '';
      } else {
        img.style.display = 'none';
      }
      const choicesDiv = document.getElementById('choices');
      choicesDiv.innerHTML = '';
      if (data.combat) {
        (data.combat_choices || []).forEach((choice, i) => {
          const btn = document.createElement('button');
          btn.className = 'choice-btn';
          btn.textContent = choice;
          btn.setAttribute('tabindex', 0);
          btn.setAttribute('aria-label', choice);
          btn.onclick = () => submitChoice(choice);
          btn.style.setProperty('--btn-delay', `${0.2 + i * 0.13}s`);
          choicesDiv.appendChild(btn);
        });
      } else {
        (data.choices || []).forEach((choice, i) => {
          const btn = document.createElement('button');
          btn.className = 'choice-btn';
          btn.textContent = choice;
          btn.setAttribute('tabindex', 0);
          btn.setAttribute('aria-label', choice);
          btn.onclick = () => submitChoice(choice);
          btn.style.setProperty('--btn-delay', `${0.2 + i * 0.13}s`);
          choicesDiv.appendChild(btn);
        });
      }
      // Show danger/combat indicator if present
      const dangerDiv = document.getElementById('danger-indicator');
      if (data.danger) {
        dangerDiv.style.display = '';
        dangerDiv.textContent = '‚ö†Ô∏è Danger! Threat detected in the scene.';
      } else if (data.combat) {
        dangerDiv.style.display = '';
        dangerDiv.textContent = `‚öîÔ∏è ${data.combat_message || 'Combat imminent!'}`;
      } else {
        dangerDiv.style.display = 'none';
        dangerDiv.textContent = '';
      }
      // Set alt text for images
      if (data.vision_dispatch || data.dispatch) {
        img.alt = data.vision_dispatch || data.dispatch;
      } else {
        img.alt = '';
      }
      revealCinematic();
      // Handle Game Over overlay
      const gameover = document.getElementById('gameover-overlay');
      if ((data.consequences && /you are killed|game over/i.test(data.consequences)) || (data.combat_result && /you are killed|game over/i.test(data.combat_result))) {
        gameover.classList.add('visible');
      } else {
        gameover.classList.remove('visible');
      }
    }
    async function submitChoice(choice) {
      document.getElementById('narrative').textContent = 'Advancing...';
      const res = await fetch('/api/choose', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ choice })
      });
      const data = await res.json();
      // Dice suspense for combat result
      const suspense = document.getElementById('dice-suspense');
      if ((data.consequences && /you attack and win|you attack and fail|you run and escape|you try to run but are caught|you are killed|game over/i.test(data.consequences)) || (data.combat_result && /you attack and win|you attack and fail|you run and escape|you try to run but are caught|you are killed|game over/i.test(data.combat_result))) {
        suspense.classList.add('visible');
        await new Promise(r => setTimeout(r, 1600));
        suspense.classList.remove('visible');
      }
      // Show the new state
      document.getElementById('narrative').textContent = data.situation_report || data.dispatch || '...';
      // Consequence feedback (hide if not present)
      const consequenceDiv = document.getElementById('consequence');
      if (data.consequences) {
        consequenceDiv.style.display = '';
        consequenceDiv.textContent = `‚ö†Ô∏è Consequence: ${data.consequences}`;
        consequenceDiv.classList.remove('consequence-pulse');
        void consequenceDiv.offsetWidth; // force reflow for animation
        consequenceDiv.classList.add('consequence-pulse');
      } else {
        consequenceDiv.style.display = 'none';
        consequenceDiv.textContent = '';
        consequenceDiv.classList.remove('consequence-pulse');
      }
      const img = document.getElementById('story-image');
      if (data.image || data.world_image) {
        img.src = data.image || data.world_image;
        img.style.display = '';
      } else {
        img.style.display = 'none';
      }
      const choicesDiv = document.getElementById('choices');
      choicesDiv.innerHTML = '';
      if (data.combat) {
        (data.combat_choices || []).forEach((choice, i) => {
          const btn = document.createElement('button');
          btn.className = 'choice-btn';
          btn.textContent = choice;
          btn.setAttribute('tabindex', 0);
          btn.setAttribute('aria-label', choice);
          btn.onclick = () => submitChoice(choice);
          btn.style.setProperty('--btn-delay', `${0.2 + i * 0.13}s`);
          choicesDiv.appendChild(btn);
        });
      } else {
        (data.choices || []).forEach((choice, i) => {
          const btn = document.createElement('button');
          btn.className = 'choice-btn';
          btn.textContent = choice;
          btn.setAttribute('tabindex', 0);
          btn.setAttribute('aria-label', choice);
          btn.onclick = () => submitChoice(choice);
          btn.style.setProperty('--btn-delay', `${0.2 + i * 0.13}s`);
          choicesDiv.appendChild(btn);
        });
      }
      // Show danger/combat indicator if present
      const dangerDiv = document.getElementById('danger-indicator');
      if (data.danger) {
        dangerDiv.style.display = '';
        dangerDiv.textContent = '‚ö†Ô∏è Danger! Threat detected in the scene.';
      } else if (data.combat) {
        dangerDiv.style.display = '';
        dangerDiv.textContent = `‚öîÔ∏è ${data.combat_message || 'Combat imminent!'}`;
      } else {
        dangerDiv.style.display = 'none';
        dangerDiv.textContent = '';
      }
      // Set alt text for images
      if (data.vision_dispatch || data.dispatch) {
        img.alt = data.vision_dispatch || data.dispatch;
      } else {
        img.alt = '';
      }
      revealCinematic();
      // Handle Game Over overlay
      const gameover = document.getElementById('gameover-overlay');
      if ((data.consequences && /you are killed|game over/i.test(data.consequences)) || (data.combat_result && /you are killed|game over/i.test(data.combat_result))) {
        gameover.classList.add('visible');
      } else {
        gameover.classList.remove('visible');
      }
    }
    async function resetGame() {
      await fetch('/api/reset', { method: 'POST' });
      fetchState();
    }
    fetchState();
  </script>
</body>
</html> 